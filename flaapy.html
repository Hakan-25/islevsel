<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HakanTools | Flappy Hakan (Final Edition)</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        /* TEMEL AYARLAR */
        body { margin: 0; padding: 0; background-color: #4ec0ca; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Inter', sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* UI KATMANI */
        #ui-container {
            position: fixed; top: 20px; left: 0; width: 100%;
            text-align: center; color: white; z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; gap: 5px; 
        }

        /* SAƒû √úST KONTROLLER */
        #top-controls {
            position: fixed; top: 20px; right: 20px; z-index: 101; display: flex; gap: 10px;
        }

        .icon-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.5); color: white;
            width: 45px; height: 45px; border-radius: 50%;
            font-size: 20px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; backdrop-filter: blur(4px); transition: 0.1s;
            pointer-events: auto;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.6); }

        #current-score {
            font-size: 60px; font-weight: 900; line-height: 1;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2); font-variant-numeric: tabular-nums; margin-bottom: 5px;
        }

        .sub-stats {
            display: flex; gap: 15px; align-items: center;
            background: rgba(0, 0, 0, 0.4); padding: 8px 20px; border-radius: 50px;
            font-size: 16px; font-weight: 700; backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .stat-box { display: flex; align-items: center; gap: 6px; }

        /* --- ALT BUTON GRUBU --- */
        #bottom-controls {
            position: fixed; bottom: 15%; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 15px; z-index: 100; pointer-events: none; 
        }

        /* ORTAK BUTON STƒ∞Lƒ∞ */
        .menu-btn { 
            pointer-events: auto; padding: 12px 20px; 
            border-radius: 50px; font-weight: 900; font-size: 14px;
            text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2); transition: 0.1s; color: white;
            text-decoration: none; display: flex; align-items: center; gap: 5px;
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }

        /* √ñZEL RENKLER */
        .btn-market { background: #f1c40f; box-shadow: 0 5px 0 #d35400; }
        .btn-leaderboard { background: #9b59b6; box-shadow: 0 5px 0 #8e44ad; }
        .btn-menu { background: #ffffff; color: #4ec0ca; box-shadow: 0 5px 0 #3da0a9; }
        .btn-login { background: #2ecc71; color:white; width: 100%; margin-top:10px; box-shadow: 0 5px 0 #27ae60; justify-content: center;}

        /* MODALLAR */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 320px; padding: 25px; border-radius: 20px;
            text-align: center; border: 4px solid #4ec0ca; position: relative;
        }
        .close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa;
        }

        /* Gƒ∞Rƒ∞≈û EKRANI √ñZEL */
        #login-modal { display: flex; z-index: 300; background: #4ec0ca; }
        .login-box { 
            background: white; padding: 30px; border-radius: 20px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center; width: 300px;
        }
        .login-input {
            width: 85%; padding: 12px; margin: 10px 0; border: 2px solid #ddd; 
            border-radius: 10px; font-size: 16px; text-align: center; font-weight: bold; outline: none;
        }
        .login-input:focus { border-color: #4ec0ca; }

        /* SIRALAMA Lƒ∞STESƒ∞ */
        .leaderboard-list {
            max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px;
        }
        .score-row {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px solid #eee; font-weight: bold; color: #555;
        }
        .score-row:nth-child(1) { color: #f1c40f; font-size: 1.2em; }

        /* BA≈ûLANGI√á EKRANI */
        #start-screen {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 90; display: none; /* Login kontrol√º ile a√ßƒ±lacak */
            flex-direction: column; gap: 10px; align-items: center;
        }
        #start-msg {
            font-size: 24px; color: white; font-weight: bold; text-shadow: 2px 2px 0 #000;
            animation: pulse 1s infinite; pointer-events: none;
        }
        #pause-msg {
            font-size: 30px; color: white; font-weight: 900; text-shadow: 3px 3px 0 #000;
            display: none; pointer-events: none;
        }
        #new-record-msg { 
            color: #f1c40f; font-weight: 900; font-size: 18px; text-shadow: 1px 1px 0 #000; 
            margin-top: 5px; display: none; background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 15px;
        }

        /* MARKET √ñGELERƒ∞ */
        .skin-item {
            background: #f0f0f0; padding: 10px; border-radius: 10px; margin: 10px 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .action-btn-small { padding: 5px 15px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        .btn-buy { background: #2ecc71; color: white; }
        .btn-equip { background: #3498db; color: white; }
        .btn-equipped { background: #95a5a6; color: white; cursor: default; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-modal" class="modal-overlay">
        <div class="login-box">
            <h1 style="color:#4ec0ca; margin-top:0;">HO≈ûGELDƒ∞N</h1>
            <p style="color:#666;">Sƒ±ralamada g√∂r√ºnmek i√ßin bir isim belirle.</p>
            <input type="text" id="username-input" class="login-input" placeholder="Kullanƒ±cƒ± Adƒ±" maxlength="12">
            <button class="menu-btn btn-login" onclick="saveUsername()">OYUNA BA≈ûLA</button>
            <p id="login-error" style="color:red; font-size:12px; display:none; margin-top:5px; font-weight:bold;"></p>
        </div>
    </div>

    <div id="top-controls">
        <div class="icon-btn" id="btn-sound" onclick="toggleMute()">üîä</div>
        <div class="icon-btn" id="btn-pause" onclick="togglePause()">‚è∏Ô∏è</div>
    </div>

    <div id="ui-container">
        <div class="sub-stats">
            <div class="stat-box">
                <span>üèÜ</span> <span id="best-score">0</span>
            </div>
            <div style="width: 1px; background: rgba(255,255,255,0.4); height: 15px;"></div>
            <div class="stat-box">
                <span>üí∞</span> <span id="total-coins">0</span>
            </div>
        </div>
        <div id="current-score">0</div>
        <div id="display-username" style="font-size: 14px; margin-top:5px; opacity: 0.8; font-weight: bold;"></div>
    </div>

    <div id="start-screen">
        <div id="start-msg">BA≈ûLAMAK ƒ∞√áƒ∞N DOKUN</div>
        <div id="pause-msg">OYUN DURAKLATILDI</div>
        <div id="new-record-msg">YENƒ∞ REKOR! KAYDEDƒ∞LDƒ∞ ‚úÖ</div>
    </div>

    <div id="bottom-controls">
        <button class="menu-btn btn-market" onclick="toggleMarket(true)">üõí MARKET</button>
        <button class="menu-btn btn-leaderboard" onclick="window.openLeaderboard()">üèÜ SIRALAMA</button>
        <button class="menu-btn btn-menu" onclick="window.location.reload()">üîÑ YENƒ∞LE</button>
    </div>

    <div id="market-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleMarket(false)">&times;</span>
            <h2 style="margin-top:0; color:#4ec0ca;">KU≈û MARKETƒ∞</h2>
            <div style="margin-bottom:15px;">Paran: <span id="market-coins">0</span> üí∞</div>
            <div id="skins-list"></div>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('leaderboard-modal').style.display='none'">&times;</span>
            <h2 style="margin-top:0; color:#9b59b6;">üèÜ EN ƒ∞Yƒ∞ 10</h2>
            <div class="leaderboard-list" id="leaderboard-content">
                Y√ºkleniyor...
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBW8xNsDjp3duXyuPukuBKNlOYw-uv6W1c",
            authDomain: "hakantools-a44c0.firebaseapp.com",
            projectId: "hakantools-a44c0",
            storageBucket: "hakantools-a44c0.firebasestorage.app",
            messagingSenderId: "216753237718",
            appId: "1:216753237718:web:ea012c7dc4fdb7e7d72377",
            measurementId: "G-4GWK9BS40T"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // OTOMATƒ∞K SKOR G√ñNDERME (Tek Kullanƒ±cƒ± = Tek Kayƒ±t)
        window.autoSubmitScore = async function(score) {
            const name = localStorage.getItem('flappy_username');
            if(!name || score <= 0) return;

            // Dok√ºman ID'sini kullanƒ±cƒ± adƒ± olarak belirle
            const userRef = doc(db, "leaderboard", name);

            try {
                const docSnap = await getDoc(userRef);

                if (docSnap.exists()) {
                    // Kullanƒ±cƒ± zaten varsa ve yeni skor daha iyiyse g√ºncelle
                    if (score > docSnap.data().score) {
                        await updateDoc(userRef, {
                            score: score,
                            date: serverTimestamp()
                        });
                        showRecordMsg();
                        console.log("Rekor g√ºncellendi.");
                    }
                } else {
                    // Kullanƒ±cƒ± yoksa yeni kayƒ±t olu≈ütur
                    await setDoc(userRef, {
                        name: name,
                        score: score,
                        date: serverTimestamp()
                    });
                    showRecordMsg();
                    console.log("Yeni kayƒ±t olu≈üturuldu.");
                }
            } catch (e) {
                console.error("Skor hatasƒ±: ", e);
            }
        };

        function showRecordMsg() {
            const msg = document.getElementById('new-record-msg');
            msg.style.display = 'block';
            setTimeout(() => { msg.style.display = 'none'; }, 3000);
        }

        window.openLeaderboard = async function() {
            if (typeof gameHasStarted !== 'undefined' && gameHasStarted && !gameOverFlag) return;

            const modal = document.getElementById('leaderboard-modal');
            const content = document.getElementById('leaderboard-content');
            modal.style.display = 'flex';
            content.innerHTML = "Veriler y√ºkleniyor...";

            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                let html = "";
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                    html += `
                        <div class="score-row">
                            <span style="width:40px;">${medal}</span>
                            <span style="flex-grow:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; max-width:150px;">${data.name}</span>
                            <span>${data.score}</span>
                        </div>
                    `;
                    rank++;
                });

                if(html === "") html = "<p style='text-align:center'>Hen√ºz kayƒ±t yok.</p>";
                content.innerHTML = html;

            } catch (e) {
                console.error(e);
                content.innerHTML = "Veri √ßekilemedi. Baƒülantƒ±nƒ±zƒ± kontrol edin.";
            }
        };
    </script>

    <script>
    // --- OYUN DEƒûƒ∞≈ûKENLERƒ∞ ---
    let game;
    let gameHasStarted = false;
    let gameOverFlag = false;
    let score = 0;

    // --- KULLANICI ADI VE Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ ---
    const badWords = ["mk", "amk", "aq", "oc", "pic", "yarak", "o√ß", "bok", "siktir", "sik", "anan", "bacƒ±n", "ka≈üar", "g√∂t"];

    function checkLoginStatus() {
        const savedName = localStorage.getItem('flappy_username');
        if (savedName) {
            document.getElementById('login-modal').style.display = 'none';
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('display-username').innerText = savedName;
            initGame(); // Giri≈ü yapƒ±ldƒ±ysa oyunu ba≈ülat
        } else {
            document.getElementById('login-modal').style.display = 'flex';
            document.getElementById('start-screen').style.display = 'none';
        }
    }

    function saveUsername() {
        const input = document.getElementById('username-input');
        const errorMsg = document.getElementById('login-error');
        let name = input.value.trim();

        if (name.length < 3) {
            errorMsg.innerText = "ƒ∞sim en az 3 karakter olmalƒ±.";
            errorMsg.style.display = 'block';
            return;
        }

        let isBad = false;
        badWords.forEach(word => {
            if (name.toLowerCase().includes(word)) isBad = true;
        });

        if (isBad) {
            errorMsg.innerText = "Bu ismi kullanamazsƒ±n!";
            errorMsg.style.display = 'block';
            return;
        }

        localStorage.setItem('flappy_username', name);
        checkLoginStatus();
    }

    window.onload = function() {
        checkLoginStatus();
    };

    // --- VERƒ∞ Y√ñNETƒ∞Mƒ∞ ---
    let bestScore = parseInt(localStorage.getItem('flappy_best')) || 0;
    let totalCoins = parseInt(localStorage.getItem('flappy_coins')) || 0;
    
    // Market Verileri
    let ownedSkins = JSON.parse(localStorage.getItem('flappy_ownedSkins')) || ['default'];
    let currentSkin = localStorage.getItem('flappy_currentSkin') || 'default';

    // Skin Veritabanƒ± (G√∂rsel y√ºklemesi olmadƒ±ƒüƒ± i√ßin renk kodlarƒ± ile)
    const skinsDB = [
        { id: 'default', name: 'Sarƒ± Ku≈ü', price: 0, color: 0xffeb3b },
        { id: 'red', name: 'Kƒ±zƒ±l Baron', price: 350, color: 0xe74c3c },
        { id: 'blue', name: 'Jet Hakan', price: 500, color: 0x3498db }
    ];

    document.getElementById('best-score').innerText = bestScore;
    document.getElementById('total-coins').innerText = totalCoins;

    // --- SES Y√ñNETƒ∞Mƒ∞ ---
    let isMuted = false;
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById('btn-sound');
        if (isMuted) {
            btn.innerText = 'üîá';
            if (audioCtx.state === 'running') audioCtx.suspend();
        } else {
            btn.innerText = 'üîä';
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
    }

    function playSynthSound(type) {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        const now = audioCtx.currentTime;

        if (type === 'jump') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(350, now);
            osc.frequency.exponentialRampToValueAtTime(500, now + 0.1);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'coin') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(1200, now);
            osc.frequency.exponentialRampToValueAtTime(1800, now + 0.1);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            osc.start(); osc.stop(now + 0.15);
        } else if (type === 'dead') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
        }
    }

    // --- MARKET FONKSƒ∞YONLARI ---
    function toggleMarket(show) {
        if (gameHasStarted && !gameOverFlag) return;
        const modal = document.getElementById('market-modal');
        if (show) { modal.style.display = 'flex'; renderMarket(); } 
        else { modal.style.display = 'none'; }
    }

    function renderMarket() {
        const list = document.getElementById('skins-list');
        const coinDisplay = document.getElementById('market-coins');
        coinDisplay.innerText = totalCoins;
        list.innerHTML = '';

        skinsDB.forEach(skin => {
            const item = document.createElement('div');
            item.className = 'skin-item';
            
            let btnHtml = '';
            // Renk g√∂stergesi
            const colorBox = `<span style="display:inline-block; width:15px; height:15px; background:${skin.color.toString(16).replace('0x','#')}; border-radius:50%; margin-right:5px;"></span>`;
            
            if (ownedSkins.includes(skin.id)) {
                if (currentSkin === skin.id) {
                    btnHtml = `<button class="action-btn-small btn-equipped">SE√áƒ∞Lƒ∞</button>`;
                } else {
                    btnHtml = `<button class="action-btn-small btn-equip" onclick="equipSkin('${skin.id}')">SE√á</button>`;
                }
            } else {
                if (totalCoins >= skin.price) {
                    btnHtml = `<button class="action-btn-small btn-buy" onclick="buySkin('${skin.id}', ${skin.price})">${skin.price} üí∞</button>`;
                } else {
                    btnHtml = `<button class="action-btn-small" style="background:#ccc; cursor:not-allowed;">${skin.price} üí∞</button>`;
                }
            }
            item.innerHTML = `<div>${colorBox}<span class="skin-name">${skin.name}</span></div> ${btnHtml}`;
            list.appendChild(item);
        });
    }

    function buySkin(id, price) {
        if (totalCoins >= price && !ownedSkins.includes(id)) {
            totalCoins -= price;
            ownedSkins.push(id);
            localStorage.setItem('flappy_coins', totalCoins);
            localStorage.setItem('flappy_ownedSkins', JSON.stringify(ownedSkins));
            
            document.getElementById('total-coins').innerText = totalCoins;
            playSynthSound('coin'); 
            renderMarket();
        }
    }

    // --- EKSƒ∞K VE YARIM KALAN B√ñL√úMLERƒ∞N TAMAMLANMI≈û HALƒ∞ ---
    
    // Skin se√ßme fonksiyonu (Kesilen b√∂l√ºm)
    window.equipSkin = function(id) {
        if (ownedSkins.includes(id)) {
            currentSkin = id;
            localStorage.setItem('flappy_currentSkin', currentSkin);
            renderMarket();
            
            // Eƒüer oyun a√ßƒ±ksa ku≈üun rengini ve ≈üeklini anlƒ±k g√ºncelle
            if (game && game.scene.scenes[0] && game.scene.scenes[0].bird) {
                const scene = game.scene.scenes[0];
                const skinData = skinsDB.find(s => s.id === currentSkin);
                scene.bird.setFillStyle(skinData.color);
                
                // Kullanƒ±cƒ±nƒ±n istediƒüi √∂zel hitbox mantƒ±ƒüƒ± (√∂rnek)
                if (currentSkin === 'red') {
                    // Kƒ±rmƒ±zƒ± ku≈ü i√ßin √∂zel hitbox (√∂rneƒüin daha k√º√ß√ºk)
                    scene.bird.body.setCircle(15); 
                } else {
                    // Varsayƒ±lan kare hitbox
                    scene.bird.body.setSize(30, 30);
                }
            }
        }
    }

    // --- PHASER OYUN MOTORU (Kayƒ±p olan 150 satƒ±rƒ±n tamamlanmƒ±≈ü hali) ---
    function initGame() {
        if (game) return; // √áift ba≈ülatmayƒ± √∂nle

        const config = {
            type: Phaser.AUTO,
            width: window.innerWidth,
            height: window.innerHeight,
            backgroundColor: '#4ec0ca',
            parent: 'body',
            physics: {
                default: 'arcade',
                arcade: { gravity: { y: 0 }, debug: false }
            },
            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };
        game = new Phaser.Game(config);
        window.gameInstance = game;
    }

    function preload() {
        // Resim dosyalarƒ± olmadƒ±ƒüƒ± i√ßin Phaser Graphics kullanƒ±yoruz.
    }

    function create() {
        this.pipes = this.physics.add.group();
        
        // Ku≈ü olu≈üturma (Senin kodunda "bird" deƒüi≈ükeni vardƒ±, onu korudum)
        const skinData = skinsDB.find(s => s.id === currentSkin) || skinsDB[0];
        
        // Basit kare yerine ku≈ü temsili
        this.bird = this.add.rectangle(100, this.scale.height / 2, 30, 30, skinData.color);
        this.physics.add.existing(this.bird);
        this.bird.body.setCollideWorldBounds(true);
        
        // Skin'e g√∂re √∂zel hitbox ayarƒ± (Senin kestiƒüin kƒ±sƒ±mdaki mantƒ±k)
        if (currentSkin === 'red') {
            this.bird.body.setCircle(15);
        }

        // Kontroller
        this.input.on('pointerdown', jump, this);
        this.input.keyboard.on('keydown-SPACE', jump, this);

        // UI'yƒ± oyuna baƒüla
        this.scoreTimer = null;
    }

    function jump() {
        if (gameOverFlag) {
            window.location.reload(); // Temiz bir yeniden ba≈ülatma
            return;
        }

        if (!gameHasStarted) {
            startGame(this);
        }

        if (this.physics.world.isPaused) return;

        this.bird.body.setVelocityY(-350);
        playSynthSound('jump');
        
        // Zƒ±plama Animasyonu (D√∂n√º≈ü Efekti)
        this.tweens.add({
            targets: this.bird,
            angle: -20,
            duration: 100,
            onComplete: () => {
                this.tweens.add({ targets: this.bird, angle: 0, duration: 100, delay: 100 });
            }
        });
    }

    function startGame(scene) {
        gameHasStarted = true;
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('bottom-controls').style.display = 'none'; // Men√ºy√º gizle
        
        scene.bird.body.setGravityY(1000); // Yer√ßekimini ba≈ülat
        
        addPipe(scene);
        scene.time.addEvent({
            delay: 1500, // Boru sƒ±klƒ±ƒüƒ±
            callback: () => addPipe(scene),
            loop: true
        });
    }

    function addPipe(scene) {
        if(gameOverFlag) return;
        
        const gap = 170; // Boru aralƒ±ƒüƒ±
        const pipeWidth = 60;
        const minHeight = 100;
        const maxHeight = scene.scale.height - gap - minHeight;
        const pipeHeight = Phaser.Math.Between(minHeight, maxHeight);

        // √úst Boru
        let topPipe = scene.add.rectangle(scene.scale.width + 50, pipeHeight / 2, pipeWidth, pipeHeight, 0x2ecc71);
        scene.physics.add.existing(topPipe);
        topPipe.body.allowGravity = false;
        topPipe.body.setVelocityX(-200);
        topPipe.body.immovable = true;
        scene.pipes.add(topPipe);

        // Alt Boru
        let bottomPipeY = pipeHeight + gap + ((scene.scale.height - (pipeHeight + gap)) / 2);
        let bottomPipeH = scene.scale.height - (pipeHeight + gap);
        let bottomPipe = scene.add.rectangle(scene.scale.width + 50, bottomPipeY, pipeWidth, bottomPipeH, 0x2ecc71);
        scene.physics.add.existing(bottomPipe);
        bottomPipe.body.allowGravity = false;
        bottomPipe.body.setVelocityX(-200);
        bottomPipe.body.immovable = true;
        scene.pipes.add(bottomPipe);

        // Skor √áizgisi (G√∂r√ºnmez tetikleyici)
        let scoreLine = scene.add.rectangle(scene.scale.width + 50, scene.scale.height / 2, 1, scene.scale.height, 0x000000, 0);
        scene.physics.add.existing(scoreLine);
        scoreLine.body.allowGravity = false;
        scoreLine.body.setVelocityX(-200);
        scoreLine.isScoreLine = true;
        scene.pipes.add(scoreLine);
    }

    function update() {
        if (!gameHasStarted || gameOverFlag) return;

        // Ku≈üun d√º≈üerken burnunu a≈üaƒüƒ± eƒümesi
        if (this.bird.body.velocity.y > 0) {
            this.bird.angle += 1;
            if(this.bird.angle > 20) this.bird.angle = 20;
        }

        // √áarpƒ±≈üma Kontrolleri
        this.physics.overlap(this.bird, this.pipes, (bird, pipe) => {
            if (pipe.isScoreLine) {
                pipe.destroy(); // √áizgiyi yok et ki tekrar saymasƒ±n
                score++;
                document.getElementById('current-score').innerText = score;
                playSynthSound('coin');
                
                // Her 5 skorda 1 coin ver
                if (score % 5 === 0) {
                    totalCoins++;
                    document.getElementById('total-coins').innerText = totalCoins;
                    localStorage.setItem('flappy_coins', totalCoins);
                }
            } else {
                hitPipe(); // Boruya √ßarptƒ±
            }
        });

        // Ekran dƒ±≈üƒ±na √ßƒ±karsa √∂l√ºr
        if (this.bird.y > this.scale.height || this.bird.y < 0) {
            hitPipe();
        }
        
        // Ekranƒ± terk eden borularƒ± temizle (Performans i√ßin)
        this.pipes.children.each(pipe => {
            if (pipe.x < -50) pipe.destroy();
        });
    }

    function hitPipe() {
        if (gameOverFlag) return;
        gameOverFlag = true;
        playSynthSound('dead');
        
        // Fiziƒüi durdur ve ku≈üu kƒ±zart
        game.scene.scenes[0].physics.pause();
        game.scene.scenes[0].bird.setTint(0xff0000);

        // En y√ºksek skoru kaydet
        if (score > bestScore) {
            bestScore = score;
            localStorage.setItem('flappy_best', bestScore);
            document.getElementById('best-score').innerText = bestScore;
        }

        // UI G√ºncelle
        document.getElementById('start-msg').innerText = "OYUN Bƒ∞TTƒ∞\nTEKRAR ƒ∞√áƒ∞N DOKUN";
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('bottom-controls').style.display = 'flex'; // Men√ºy√º geri getir

        // Veritabanƒ±na g√∂nder
        if (window.autoSubmitScore) window.autoSubmitScore(score);
    }

    function togglePause() {
        if (!gameHasStarted || gameOverFlag) return;
        const scene = game.scene.scenes[0];
        
        if (scene.physics.world.isPaused) {
            scene.physics.resume();
            document.getElementById('pause-msg').style.display = 'none';
            document.getElementById('btn-pause').innerText = '‚è∏Ô∏è';
        } else {
            scene.physics.pause();
            document.getElementById('pause-msg').style.display = 'block';
            document.getElementById('btn-pause').innerText = '‚ñ∂Ô∏è';
        }
    }
    </script>
</body>
</html>
