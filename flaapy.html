<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HakanTools | Flappy Hakan</title>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        /* 1. SAYFA VE KONUMLANDIRMA AYARLARI */
        body { 
            margin: 0; padding: 0; 
            background-color: #4ec0ca; 
            overflow: hidden; 
            font-family: 'Inter', sans-serif; 
            touch-action: none; 
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center; 
            -webkit-user-select: none; user-select: none;
        }

        /* 2. √úST BAR (UI) */
        #top-ui {
            position: absolute;
            top: 0; left: 0; width: 100%;
            height: 100%; 
            pointer-events: none; 
            z-index: 100;
        }

        /* Sol √úst: Ev Butonu */
        .home-btn {
            position: absolute; top: 15px; left: 15px;
            pointer-events: auto;
            text-decoration: none;
            background: white;
            width: 42px; height: 42px;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px;
            box-shadow: 0 4px 0 #2c7a81;
            border: 2px solid #fff;
        }
        .home-btn:active { transform: translateY(3px); box-shadow: none; }

        /* Saƒü √úst: ƒ∞statistikler */
        .stats-wrapper {
            position: absolute; top: 15px; right: 15px;
            display: flex; flex-direction: column; 
            align-items: flex-end; 
            gap: 8px; 
            pointer-events: auto;
        }

        .stat-pill {
            background: rgba(0, 0, 0, 0.6); 
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px; font-weight: 700;
            display: flex; align-items: center; gap: 6px;
            border: 1px solid rgba(255,255,255,0.4);
            white-space: nowrap;
        }

        .leaderboard-icon-btn {
            background: #FFD700;
            width: 42px; height: 42px;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer;
            border: 2px solid #fff;
            box-shadow: 0 3px 0 #B8860B;
            margin-top: 5px; 
        }
        .leaderboard-icon-btn:active { transform: translateY(3px); box-shadow: none; }

        /* 3. ORTA B√úY√úK SKOR */
        #game-score-container {
            position: absolute;
            top: 15%; left: 50%;
            transform: translateX(-50%);
            z-index: 10; 
            pointer-events: none;
            text-align: center;
            width: 100%;
        }
        #current-score {
            font-size: 70px; font-weight: 900; color: white;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.2);
            margin: 0; line-height: 1;
        }

        /* 4. BA≈ûLANGI√á MESAJI */
        #start-msg {
            position: absolute; top: 55%; left: 50%; 
            transform: translate(-50%, -50%);
            font-size: 20px; color: white; font-weight: 800;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            animation: pulse 1s infinite;
            pointer-events: none; z-index: 50; 
            width: 100%; text-align: center;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* 5. MODALLAR */
        #login-modal, #leaderboard-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: flex; justify-content: center; align-items: center;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #4ec0ca, #3da0a9);
            padding: 25px; border-radius: 20px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 4px solid white;
            width: 85%; max-width: 320px;
        }
        
        .modal-input {
            width: 85%; padding: 12px; font-size: 16px; border-radius: 10px; border: none;
            margin-bottom: 20px; font-family: 'Inter', sans-serif; text-align: center;
            font-weight: bold; color: #333; outline: none;
        }
        
        .modal-btn, .close-btn {
            background: #fff; color: #4ec0ca; padding: 12px 30px; border: none;
            border-radius: 50px; font-size: 16px; font-weight: 900; cursor: pointer;
            box-shadow: 0 5px 0 #2c7a81; transition: 0.1s; text-transform: uppercase;
        }
        .modal-btn:active, .close-btn:active { transform: translateY(3px); box-shadow: 0 1px 0 #2c7a81; }

        .hidden { display: none !important; }

        /* Lƒ∞DERLƒ∞K Lƒ∞STESƒ∞ */
        #leaderboard-list {
            list-style: none; padding: 0; margin: 15px 0; 
            max-height: 250px; overflow-y: auto; text-align: left;
        }
        .leaderboard-item {
            background: rgba(255,255,255,0.2); margin-bottom: 6px; padding: 8px 12px;
            border-radius: 8px; color: white; display: flex; justify-content: space-between;
            font-weight: bold; font-size: 14px;
        }
        .rank-1 { background: linear-gradient(90deg, #FFD700, #FDB931); border: 2px solid #fff; color: #333; }
        .rank-2 { background: linear-gradient(90deg, #E0E0E0, #BDBDBD); border: 1px solid #fff; color: #333; }
        .rank-3 { background: linear-gradient(90deg, #CD7F32, #A0522D); border: 1px solid #fff; color: #fff; }

        .close-btn { background: #e74c3c; color: white; box-shadow: 0 4px 0 #c0392b; }
        .close-btn:active { box-shadow: 0 1px 0 #c0392b; }

    </style>
</head>
<body>

    <div id="top-ui">
        <a href="index.html" class="home-btn">üè†</a>
        <div class="stats-wrapper">
            <div class="stat-pill">üèÜ <span id="best-score">0</span></div>
            <div class="stat-pill">üí∞ <span id="total-coins">0</span></div>
            <button class="leaderboard-icon-btn" onclick="openLeaderboard()">ü•á</button>
        </div>
        <div id="game-score-container"><div id="current-score">0</div></div>
        <div id="start-msg">BA≈ûLAMAK ƒ∞√áƒ∞N DOKUN</div>
    </div>

    <div id="login-modal">
        <div class="modal-content">
            <h2 style="color:white; margin:0 0 15px 0;">HO≈û GELDƒ∞N Pƒ∞LOT!</h2>
            <input type="text" id="nickname-input" class="modal-input" placeholder="Rumuzun (Max 10 krk)" maxlength="10">
            <button class="modal-btn" onclick="kullaniciKaydet()">KAYDET VE BA≈ûLA</button>
        </div>
    </div>

    <div id="leaderboard-modal" class="hidden">
        <div class="modal-content">
            <h2 style="color:white; margin:0 0 10px 0;">EN ƒ∞Yƒ∞ Pƒ∞LOTLAR</h2>
            <div id="loading-text" style="color:white; margin-top:20px;">Y√ºkleniyor...</div>
            <ul id="leaderboard-list"></ul>
            <button class="close-btn" onclick="closeLeaderboard()">KAPAT</button>
        </div>
    </div>

    <script>
    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyBW8xNsDjp3duXyuPukuBKNlOYw-uv6W1c",
        authDomain: "hakantools-a44c0.firebaseapp.com",
        projectId: "hakantools-a44c0",
        storageBucket: "hakantools-a44c0.firebasestorage.app",
        messagingSenderId: "216753237718",
        appId: "1:216753237718:web:ea012c7dc4fdb7e7d72377",
        measurementId: "G-4GWK9BS40T"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- DEƒûƒ∞≈ûKENLER ---
    let bird, pipes, coins, score=0, gameHasStarted=false, gameOverFlag=false;
    let bestScore = parseInt(localStorage.getItem('flappy_best')) || 0;
    let totalCoins = parseInt(localStorage.getItem('flappy_coins')) || 0;

    if(document.getElementById('best-score')) document.getElementById('best-score').innerText = bestScore;
    if(document.getElementById('total-coins')) document.getElementById('total-coins').innerText = totalCoins;

    // --- KULLANICI Y√ñNETƒ∞Mƒ∞ ---
    window.addEventListener('load', () => {
        const kayitliID = localStorage.getItem('hakan_flappy_uid');
        if (kayitliID) {
            document.getElementById('login-modal').classList.add('hidden');
            verileriGuncelle(kayitliID);
        }
    });

    function kullaniciKaydet() {
        const isim = document.getElementById('nickname-input').value.trim();
        if (isim === "") { alert("L√ºtfen bir isim yaz!"); return; }
        
        db.collection("leaderboard").add({
            name: isim, score: bestScore, coins: totalCoins, date: new Date().toLocaleString('tr-TR')
        }).then((docRef) => {
            localStorage.setItem('hakan_flappy_uid', docRef.id);
            document.getElementById('login-modal').classList.add('hidden');
        }).catch((err) => alert("Hata: " + err.message));
    }

    function verileriGuncelle(uid) {
        db.collection("leaderboard").doc(uid).onSnapshot((doc) => {
            if (doc.exists) {
                const data = doc.data();
                localStorage.setItem('flappy_best', data.score);
                localStorage.setItem('flappy_coins', data.coins || 0);
                bestScore = data.score;
                totalCoins = data.coins || 0;
                document.getElementById('best-score').innerText = bestScore;
                document.getElementById('total-coins').innerText = totalCoins;
            }
        });
    }

    function skoruDatabaseYaz(yeniSkor, toplamPara) {
        const uid = localStorage.getItem('hakan_flappy_uid');
        if (!uid) return;
        const docRef = db.collection("leaderboard").doc(uid);
        db.runTransaction((t) => {
            return t.get(docRef).then((doc) => {
                if (!doc.exists) throw "Hata";
                const eski = doc.data().score || 0;
                let kaydet = yeniSkor > eski ? yeniSkor : eski;
                t.update(docRef, { score: kaydet, coins: toplamPara, date: new Date().toLocaleString('tr-TR') });
                return kaydet;
            });
        }).then((yeniRekor) => {
            document.getElementById('best-score').innerText = yeniRekor;
        });
    }

    function openLeaderboard() {
        document.getElementById('leaderboard-modal').classList.remove('hidden');
        document.getElementById('leaderboard-list').innerHTML = "";
        document.getElementById('loading-text').style.display = "block";

        db.collection("leaderboard").orderBy("score", "desc").limit(10).get()
          .then((querySnapshot) => {
              document.getElementById('loading-text').style.display = "none";
              let rank = 1;
              const list = document.getElementById('leaderboard-list');
              querySnapshot.forEach((doc) => {
                  const data = doc.data();
                  let rankClass = rank === 1 ? "rank-1" : rank === 2 ? "rank-2" : rank === 3 ? "rank-3" : "";
                  const item = document.createElement('li');
                  item.className = `leaderboard-item ${rankClass}`;
                  item.innerHTML = `<span>${rank}. ${data.name}</span><span>${data.score}</span>`;
                  list.appendChild(item);
                  rank++;
              });
          }).catch((error) => { document.getElementById('loading-text').innerText = "Hata: " + error.message; });
    }

    function closeLeaderboard() {
        document.getElementById('leaderboard-modal').classList.add('hidden');
    }

    // --- SES Sƒ∞STEMƒ∞ ---
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        osc.connect(g); g.connect(audioCtx.destination);
        if (type === 'jump') {
            osc.frequency.setValueAtTime(350, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(500, audioCtx.currentTime + 0.1);
            g.gain.setValueAtTime(0.2, audioCtx.currentTime);
            g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'coin') {
            osc.type='square'; osc.frequency.setValueAtTime(1200, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1800, audioCtx.currentTime+0.1);
            g.gain.setValueAtTime(0.1, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.15);
            osc.start(); osc.stop(audioCtx.currentTime+0.15);
        } else if (type === 'dead') {
            osc.type='sawtooth'; osc.frequency.setValueAtTime(200, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime+0.3);
            g.gain.setValueAtTime(0.2, audioCtx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime+0.3);
            osc.start(); osc.stop(audioCtx.currentTime+0.3);
        }
    }

    // --- OYUN KONFIGURASYONU (OPTƒ∞Mƒ∞ZE EDƒ∞LDƒ∞) ---
    const config = {
        type: Phaser.AUTO,
        scale: {
            mode: Phaser.Scale.FIT,
            autoCenter: Phaser.Scale.CENTER_BOTH,
            width: 400,
            height: 600
        },
        transparent: true,
        physics: { default: 'arcade', arcade: { gravity: { y: 1200 }, debug: false } },
        scene: { create: create, update: update }
    };

    const game = new Phaser.Game(config);

    function create() {
        let cloudG = this.make.graphics();
        cloudG.fillStyle(0xFFFFFF, 1); cloudG.fillCircle(20, 20, 20); cloudG.fillCircle(45, 20, 25); cloudG.fillCircle(75, 20, 20);
        cloudG.generateTexture('cloud', 100, 50);
        this.add.image(100, 100, 'cloud').setAlpha(0.6);
        this.add.image(300, 150, 'cloud').setAlpha(0.5).setScale(0.8);

        let groundG = this.make.graphics();
        groundG.fillStyle(0xDED895, 1); groundG.fillRect(0, 15, 400, 100);
        groundG.fillStyle(0x73BF2E, 1); groundG.fillRect(0, 0, 400, 15);
        groundG.lineStyle(3, 0x558C22, 1); groundG.strokeRect(0, 0, 400, 15);
        groundG.generateTexture('ground', 400, 110);

        let coinG = this.make.graphics();
        coinG.fillStyle(0xFFD700, 1); coinG.fillCircle(16, 16, 16); coinG.fillStyle(0xB8860B, 1); coinG.fillRect(14, 9, 4, 14);
        coinG.generateTexture('coin', 32, 32);

        let pipeG = this.make.graphics();
        pipeG.fillStyle(0x73BF2E, 1); pipeG.fillRect(2, 2, 54, 600); pipeG.lineStyle(4, 0x558C22, 1); pipeG.strokeRect(0, 0, 58, 600);
        pipeG.fillStyle(0x73BF2E, 1); pipeG.fillRect(0, 0, 58, 28); pipeG.strokeRect(0, 0, 58, 28);
        pipeG.generateTexture('pipe', 60, 600);

        let birdG = this.make.graphics();
        birdG.fillStyle(0xFF69B4, 1); birdG.fillTriangle(10,8,14,0,18,8); birdG.fillTriangle(18,8,22,-2,26,8); birdG.fillTriangle(26,8,30,0,34,8);
        birdG.fillStyle(0xF4CE42, 1); birdG.fillCircle(22,20,14); birdG.fillStyle(0xFFFFFF, 1); birdG.fillCircle(28,16,6);
        birdG.fillStyle(0x000000, 1); birdG.fillCircle(30,16,2); birdG.fillStyle(0xF39C12, 1); birdG.fillTriangle(32,20,44,23,32,26);
        birdG.generateTexture('bird', 45, 40);

        pipes = this.physics.add.group(); 
        coins = this.physics.add.group();
        bird = this.physics.add.sprite(100, 300, 'bird'); bird.setDepth(10); bird.body.setCircle(13,9,7);
        
        this.ground = this.add.tileSprite(200, 600, 400, 110, 'ground').setOrigin(0.5, 1).setDepth(20);
        this.physics.add.existing(this.ground, true);

        // --- Gƒ∞Rƒ∞≈û KONTROL√ú (Input) ---
        // 'pointerdown' ile hem mouse hem dokunmatik algƒ±lanƒ±r
        this.input.on('pointerdown', jump, this); 
        this.input.keyboard.on('keydown-SPACE', jump, this);
        
        this.physics.add.collider(bird, pipes, gameOver, null, this);
        this.physics.add.collider(bird, this.ground, gameOver, null, this);
        this.physics.add.overlap(bird, coins, collectCoin, null, this);

        this.pipeTimer = this.time.addEvent({ delay: 1500, callback: addPipe, callbackScope: this, loop: true, paused: true });
    }

    // --- OPTƒ∞Mƒ∞ZE EDƒ∞LMƒ∞≈û UPDATE (Delta Time Kullanƒ±mƒ±) ---
    function update(time, delta) {
        if(!gameHasStarted) { 
            bird.body.allowGravity=false; 
            // Delta time kullanarak s√ºz√ºlme hƒ±zƒ± her ekranda aynƒ± olur
            bird.y = 300 + Math.sin(time/300)*10; 
            return; 
        }
        if(gameOverFlag) return;
        
        // Zemin hƒ±zƒ± FPS'ten baƒüƒ±msƒ±z hale getirildi
        // 60 FPS'te yakla≈üƒ±k 16.6ms ge√ßer. delta/16.6 ile normalize ediyoruz.
        let deltaFactor = delta / 16.6;
        
        this.ground.tilePositionX += 2.5 * deltaFactor;
        
        if(bird.angle < 30) bird.angle += 2.5 * deltaFactor;
        if(bird.y < -50 || bird.y > 600) gameOver.call(this);

        // --- GARBAGE COLLECTION (Kasma √á√∂z√ºm√º) ---
        // Ekrandan √ßƒ±kan borularƒ± bellekten sil
        pipes.children.iterate(function (pipe) {
            if (pipe && pipe.x < -60) {
                pipe.destroy();
            }
        });
        coins.children.iterate(function (coin) {
            if (coin && coin.x < -60) {
                coin.destroy();
            }
        });
    }

    function jump() {
        if(!document.getElementById('login-modal').classList.contains('hidden')) return;
        if(!document.getElementById('leaderboard-modal').classList.contains('hidden')) return;
        
        if(gameOverFlag) { restartGame.call(this); return; }
        
        if(!gameHasStarted) { 
            gameHasStarted=true; 
            bird.body.allowGravity=true; 
            this.pipeTimer.paused=false; 
            document.getElementById('start-msg').style.display='none'; 
            if(audioCtx.state==='suspended') audioCtx.resume();
        }
        
        bird.setVelocityY(-400); 
        this.tweens.add({ targets: bird, angle: -25, duration: 100 }); 
        playSound('jump');
    }

    function addPipe() {
        if(gameOverFlag) return;
        let gap = Math.max(90, 140-(score*0.5));
        let minPipe=80, maxPos=600-110-gap-minPipe;
        let y = Phaser.Math.Between(minPipe, maxPos);
        
        let top = pipes.create(450, y, 'pipe').setOrigin(0.5,1).setFlipY(true);
        let bot = pipes.create(450, y+gap, 'pipe').setOrigin(0.5,0);
        
        [top,bot].forEach(p=>{ 
            p.body.allowGravity=false; 
            p.setVelocityX(-200); // Fizik motoru hƒ±zƒ± zaten saniye bazlƒ±dƒ±r, delta time gerekmez
        });
        
        if(Math.random() > 0.7) {
            let c = coins.create(450, y+(gap/2), 'coin'); 
            c.setVelocityX(-200); c.body.allowGravity=false;
            this.tweens.add({ targets: c, scaleX: 0, duration: 600, yoyo: true, repeat: -1 });
        }
        
        this.time.delayedCall(1500, ()=>{ 
            if(!gameOverFlag && gameHasStarted) { 
                score++; document.getElementById('current-score').innerText=score; 
            }
        });
    }

    function collectCoin(b,c) { 
        c.destroy(); // disableBody yerine destroy kullanƒ±yoruz (daha temiz)
        totalCoins++; 
        document.getElementById('total-coins').innerText=totalCoins; 
        playSound('coin'); 
    }

    function gameOver() {
        if(gameOverFlag) return; gameOverFlag=true;
        this.physics.pause(); bird.setTint(0xff0000); playSound('dead');
        
        if(score>bestScore) { bestScore=score; localStorage.setItem('flappy_best', bestScore); }
        localStorage.setItem('flappy_coins', totalCoins);
        skoruDatabaseYaz(score, totalCoins);
        
        document.getElementById('start-msg').innerText = "TEKRAR DENE"; 
        document.getElementById('start-msg').style.display = 'block';
    }

    function restartGame() {
        gameOverFlag=false; gameHasStarted=false; score=0; 
        document.getElementById('current-score').innerText="0"; 
        this.scene.restart();
    }
    </script>
</body>
</html>
