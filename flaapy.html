<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HakanTools | Flappy Hakan (Red Baron V3 + Leaderboard)</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        /* TEMEL AYARLAR */
        body { margin: 0; padding: 0; background-color: #4ec0ca; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; font-family: 'Inter', sans-serif; user-select: none; -webkit-user-select: none; }
        
        /* UI KATMANI */
        #ui-container {
            position: fixed; top: 20px; left: 0; width: 100%;
            text-align: center; color: white; z-index: 100; pointer-events: none;
            display: flex; flex-direction: column; align-items: center; gap: 5px; 
        }

        /* SAƒû √úST KONTROLLER */
        #top-controls {
            position: fixed; top: 20px; right: 20px; z-index: 101; display: flex; gap: 10px;
        }

        .icon-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.5); color: white;
            width: 45px; height: 45px; border-radius: 50%;
            font-size: 20px; display: flex; justify-content: center; align-items: center;
            cursor: pointer; backdrop-filter: blur(4px); transition: 0.1s;
        }
        .icon-btn:active { transform: scale(0.9); background: rgba(0,0,0,0.6); }

        #current-score {
            font-size: 60px; font-weight: 900; line-height: 1;
            text-shadow: 3px 3px 0 rgba(0,0,0,0.2); font-variant-numeric: tabular-nums; margin-bottom: 5px;
        }

        .sub-stats {
            display: flex; gap: 15px; align-items: center;
            background: rgba(0, 0, 0, 0.4); padding: 8px 20px; border-radius: 50px;
            font-size: 16px; font-weight: 700; backdrop-filter: blur(4px);
            border: 1px solid rgba(255,255,255,0.3); box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .stat-box { display: flex; align-items: center; gap: 6px; }

        /* --- ALT BUTON GRUBU --- */
        #bottom-controls {
            position: fixed; bottom: 15%; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 15px; z-index: 100; pointer-events: none; 
        }

        /* ORTAK BUTON STƒ∞Lƒ∞ */
        .menu-btn { 
            pointer-events: auto; padding: 12px 20px; 
            border-radius: 50px; font-weight: 900; font-size: 14px;
            text-transform: uppercase; letter-spacing: 1px; border: none; cursor: pointer;
            box-shadow: 0 5px 0 rgba(0,0,0,0.2); transition: 0.1s; color: white;
            text-decoration: none; display: flex; align-items: center; gap: 5px;
        }
        .menu-btn:active { transform: translateY(4px); box-shadow: 0 2px 0 rgba(0,0,0,0.2); }

        /* √ñZEL RENKLER */
        .btn-market { background: #f1c40f; box-shadow: 0 5px 0 #d35400; }
        .btn-leaderboard { background: #9b59b6; box-shadow: 0 5px 0 #8e44ad; }
        .btn-menu { background: #ffffff; color: #4ec0ca; box-shadow: 0 5px 0 #3da0a9; }
        .btn-save { 
            background: #2ecc71; box-shadow: 0 5px 0 #27ae60; 
            margin-top: 15px; pointer-events: auto; display: none; /* Ba≈ülangƒ±√ßta gizli */
        }

        /* MODALLAR */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 320px; padding: 25px; border-radius: 20px;
            text-align: center; border: 4px solid #4ec0ca; position: relative;
        }
        .close-btn {
            position: absolute; top: 10px; right: 15px; font-size: 24px; cursor: pointer; color: #aaa;
        }

        /* SIRALAMA Lƒ∞STESƒ∞ */
        .leaderboard-list {
            max-height: 300px; overflow-y: auto; text-align: left; margin-bottom: 15px;
        }
        .score-row {
            display: flex; justify-content: space-between; padding: 8px 0;
            border-bottom: 1px solid #eee; font-weight: bold; color: #555;
        }
        .score-row:nth-child(1) { color: #f1c40f; font-size: 1.2em; }

        /* INPUT */
        .input-group input {
            width: 80%; padding: 10px; border-radius: 10px; border: 2px solid #ddd;
            font-size: 16px; margin-bottom: 10px; text-align: center; font-weight: bold;
        }

        /* BA≈ûLANGI√á EKRANI */
        #start-screen {
            position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
            text-align: center; z-index: 90; display: flex; flex-direction: column; gap: 10px; align-items: center;
        }
        #start-msg {
            font-size: 24px; color: white; font-weight: bold; text-shadow: 2px 2px 0 #000;
            animation: pulse 1s infinite; pointer-events: none;
        }
        #pause-msg {
            font-size: 30px; color: white; font-weight: 900; text-shadow: 3px 3px 0 #000;
            display: none; pointer-events: none;
        }

        /* MARKET √ñGELERƒ∞ */
        .skin-item {
            background: #f0f0f0; padding: 10px; border-radius: 10px; margin: 10px 0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .action-btn-small { padding: 5px 15px; border-radius: 5px; border: none; font-weight: bold; cursor: pointer; }
        .btn-buy { background: #2ecc71; color: white; }
        .btn-equip { background: #3498db; color: white; }
        .btn-equipped { background: #95a5a6; color: white; cursor: default; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <div id="top-controls">
        <div class="icon-btn" id="btn-sound" onclick="toggleMute()">üîä</div>
        <div class="icon-btn" id="btn-pause" onclick="togglePause()">‚è∏Ô∏è</div>
    </div>

    <div id="ui-container">
        <div class="sub-stats">
            <div class="stat-box">
                <span>üèÜ</span> <span id="best-score">0</span>
            </div>
            <div style="width: 1px; background: rgba(255,255,255,0.4); height: 15px;"></div>
            <div class="stat-box">
                <span>üí∞</span> <span id="total-coins">0</span>
            </div>
        </div>
        <div id="current-score">0</div>
    </div>

    <div id="start-screen">
        <div id="start-msg">BA≈ûLAMAK ƒ∞√áƒ∞N DOKUN</div>
        <div id="pause-msg">OYUN DURAKLATILDI</div>
        <button id="save-score-btn" class="menu-btn btn-save" onclick="openSaveModal()">üíæ SKORU KAYDET</button>
    </div>

    <div id="bottom-controls">
        <button class="menu-btn btn-market" onclick="toggleMarket(true)">üõí MARKET</button>
        <button class="menu-btn btn-leaderboard" onclick="window.openLeaderboard()">üèÜ SIRALAMA</button>
        <a href="index.html" class="menu-btn btn-menu">üè† MEN√ú</a>
    </div>

    <div id="market-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="toggleMarket(false)">&times;</span>
            <h2 style="margin-top:0; color:#4ec0ca;">KU≈û MARKETƒ∞</h2>
            <div style="margin-bottom:15px;">Paran: <span id="market-coins">0</span> üí∞</div>
            <div id="skins-list"></div>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('leaderboard-modal').style.display='none'">&times;</span>
            <h2 style="margin-top:0; color:#9b59b6;">üèÜ EN ƒ∞Yƒ∞ 10</h2>
            <div class="leaderboard-list" id="leaderboard-content">
                Y√ºkleniyor...
            </div>
        </div>
    </div>

    <div id="save-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="close-btn" onclick="document.getElementById('save-modal').style.display='none'">&times;</span>
            <h2 style="margin-top:0; color:#2ecc71;">SKORU KAYDET</h2>
            <p>Skorun: <strong id="score-to-save" style="font-size:20px;">0</strong></p>
            <div class="input-group">
                <input type="text" id="player-name" placeholder="Adƒ±n (Max 10 krk)" maxlength="10">
            </div>
            <button class="menu-btn btn-save" style="display:inline-block; margin:0;" onclick="window.submitScoreToFirebase()">G√ñNDER</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBW8xNsDjp3duXyuPukuBKNlOYw-uv6W1c",
            authDomain: "hakantools-a44c0.firebaseapp.com",
            projectId: "hakantools-a44c0",
            storageBucket: "hakantools-a44c0.firebasestorage.app",
            messagingSenderId: "216753237718",
            appId: "1:216753237718:web:ea012c7dc4fdb7e7d72377",
            measurementId: "G-4GWK9BS40T"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Global Fonksiyonlar
        window.submitScoreToFirebase = async function() {
            const nameInput = document.getElementById('player-name');
            const name = nameInput.value.trim() || "Anonim";
            const score = parseInt(document.getElementById('score-to-save').innerText);

            if(score <= 0) { alert("0 Puan kaydedilemez!"); return; }

            const submitBtn = document.querySelector('#save-modal .btn-save');
            submitBtn.innerText = "Y√ºkleniyor...";
            submitBtn.disabled = true;

            try {
                await addDoc(collection(db, "leaderboard"), {
                    name: name,
                    score: score,
                    date: new Date()
                });
                alert("Skor ba≈üarƒ±yla kaydedildi!");
                document.getElementById('save-modal').style.display = 'none';
                document.getElementById('save-score-btn').style.display = 'none';
            } catch (e) {
                console.error("Hata: ", e);
                alert("Kayƒ±t ba≈üarƒ±sƒ±z! ƒ∞nternetini kontrol et.");
            } finally {
                submitBtn.innerText = "G√ñNDER";
                submitBtn.disabled = false;
            }
        };

        window.openLeaderboard = async function() {
            // Oyun oynanƒ±rken a√ßƒ±lmasƒ±nƒ± engelle
            if (typeof gameHasStarted !== 'undefined' && gameHasStarted && !gameOverFlag) return;

            const modal = document.getElementById('leaderboard-modal');
            const content = document.getElementById('leaderboard-content');
            modal.style.display = 'flex';
            content.innerHTML = "Veriler y√ºkleniyor...";

            try {
                const q = query(collection(db, "leaderboard"), orderBy("score", "desc"), limit(10));
                const querySnapshot = await getDocs(q);
                
                let html = "";
                let rank = 1;
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    let medal = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
                    html += `
                        <div class="score-row">
                            <span style="width:40px;">${medal}</span>
                            <span style="flex-grow:1;">${data.name}</span>
                            <span>${data.score}</span>
                        </div>
                    `;
                    rank++;
                });

                if(html === "") html = "<p>Hen√ºz kayƒ±t yok.</p>";
                content.innerHTML = html;

            } catch (e) {
                console.error(e);
                content.innerHTML = "Veri √ßekilemedi. Baƒülantƒ±nƒ±zƒ± kontrol edin.";
            }
        };
    </script>

    <script>
    // --- VERƒ∞ Y√ñNETƒ∞Mƒ∞ ---
    let bestScore = localStorage.getItem('flappy_best') || 0;
    let totalCoins = parseInt(localStorage.getItem('flappy_coins')) || 0;
    
    // Market Verileri
    let ownedSkins = JSON.parse(localStorage.getItem('flappy_ownedSkins')) || ['default'];
    let currentSkin = localStorage.getItem('flappy_currentSkin') || 'default';

    // Market √úr√ºnleri
    const skinsDB = [
        { id: 'default', name: 'Sarƒ± Ku≈ü', price: 0 },
        { id: 'red', name: 'Kƒ±zƒ±l Baron', price: 350 },
        { id: 'blue', name: 'Jet Hakan', price: 500 }
    ];

    document.getElementById('best-score').innerText = bestScore;
    document.getElementById('total-coins').innerText = totalCoins;

    function openSaveModal() {
        document.getElementById('score-to-save').innerText = score;
        document.getElementById('save-modal').style.display = 'flex';
    }

    // --- SES Y√ñNETƒ∞Mƒ∞ ---
    let isMuted = false;
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    const audioCtx = new AudioContext();

    function toggleMute() {
        isMuted = !isMuted;
        const btn = document.getElementById('btn-sound');
        if (isMuted) {
            btn.innerText = 'üîá';
            if (audioCtx.state === 'running') audioCtx.suspend();
        } else {
            btn.innerText = 'üîä';
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }
    }

    function playSynthSound(type) {
        if (isMuted) return;
        if (audioCtx.state === 'suspended') audioCtx.resume();
        
        const osc = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        osc.connect(gainNode);
        gainNode.connect(audioCtx.destination);

        const now = audioCtx.currentTime;

        if (type === 'jump') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(350, now);
            osc.frequency.exponentialRampToValueAtTime(500, now + 0.1);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(); osc.stop(now + 0.1);
        } else if (type === 'coin') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(1200, now);
            osc.frequency.exponentialRampToValueAtTime(1800, now + 0.1);
            gainNode.gain.setValueAtTime(0.1, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
            osc.start(); osc.stop(now + 0.15);
        } else if (type === 'dead') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(200, now);
            osc.frequency.exponentialRampToValueAtTime(50, now + 0.3);
            gainNode.gain.setValueAtTime(0.3, now);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            osc.start(); osc.stop(now + 0.3);
        }
    }

    // --- MARKET FONKSƒ∞YONLARI ---
    function toggleMarket(show) {
        if (gameHasStarted && !gameOverFlag) return;

        const modal = document.getElementById('market-modal');
        if (show) { 
            modal.style.display = 'flex'; 
            renderMarket(); 
        } else { 
            modal.style.display = 'none'; 
        }
    }

    function renderMarket() {
        const list = document.getElementById('skins-list');
        const coinDisplay = document.getElementById('market-coins');
        coinDisplay.innerText = totalCoins;
        list.innerHTML = '';

        skinsDB.forEach(skin => {
            const item = document.createElement('div');
            item.className = 'skin-item';
            
            let btnHtml = '';
            
            if (ownedSkins.includes(skin.id)) {
                if (currentSkin === skin.id) {
                    btnHtml = `<button class="action-btn-small btn-equipped">SE√áƒ∞Lƒ∞</button>`;
                } else {
                    btnHtml = `<button class="action-btn-small btn-equip" onclick="equipSkin('${skin.id}')">SE√á</button>`;
                }
            } else {
                if (totalCoins >= skin.price) {
                    btnHtml = `<button class="action-btn-small btn-buy" onclick="buySkin('${skin.id}', ${skin.price})">${skin.price} üí∞</button>`;
                } else {
                    btnHtml = `<button class="action-btn-small" style="background:#ccc; cursor:not-allowed;">${skin.price} üí∞</button>`;
                }
            }
            item.innerHTML = `<span class="skin-name">${skin.name}</span> ${btnHtml}`;
            list.appendChild(item);
        });
    }

    function buySkin(id, price) {
        if (totalCoins >= price && !ownedSkins.includes(id)) {
            totalCoins -= price;
            ownedSkins.push(id);
            localStorage.setItem('flappy_coins', totalCoins);
            localStorage.setItem('flappy_ownedSkins', JSON.stringify(ownedSkins));
            
            document.getElementById('total-coins').innerText = totalCoins;
            playSynthSound('coin'); 
            renderMarket();
        }
    }

    function equipSkin(id) {
        if (ownedSkins.includes(id)) {
            currentSkin = id;
            localStorage.setItem('flappy_currentSkin', currentSkin);
            renderMarket();
            
            if (game.scene.scenes[0] && game.scene.scenes[0].bird) {
                let scene = game.scene.scenes[0];
                scene.bird.setTexture('bird_' + currentSkin);
                if (currentSkin === 'red') scene.bird.body.setCircle(15, 12, 8);
                else scene.bird.body.setCircle(13, 9, 7);
            }
        }
    }

    // --- OYUN DURDURMA ---
    let isGamePaused = false;
    function togglePause() {
        if (!gameHasStarted || gameOverFlag) return; 

        const scene = game.scene.scenes[0];
        const btn = document.getElementById('btn-pause');
        const startScreen = document.getElementById('start-screen');
        const pauseMsg = document.getElementById('pause-msg');
        const startMsg = document.getElementById('start-msg');
        const saveBtn = document.getElementById('save-score-btn');

        if (!isGamePaused) {
            isGamePaused = true;
            scene.physics.pause();
            scene.pipeTimer.paused = true;
            btn.innerText = '‚ñ∂Ô∏è';
            
            startScreen.style.display = 'flex';
            startMsg.style.display = 'none';
            pauseMsg.style.display = 'block';
            saveBtn.style.display = 'none'; // Pause ekranƒ±nda save butonu gizlensin

        } else {
            isGamePaused = false;
            scene.physics.resume();
            scene.pipeTimer.paused = false;
            btn.innerText = '‚è∏Ô∏è';
            
            startScreen.style.display = 'none';
            pauseMsg.style.display = 'none';
            startMsg.style.display = 'block';
        }
    }

    // --- PHASER AYARLARI ---
    const isMobile = window.innerWidth < 768;
    const config = {
        type: Phaser.AUTO,
        width: isMobile ? window.innerWidth : 400,
        height: isMobile ? window.innerHeight : 600,
        transparent: false,
        backgroundColor: '#4ec0ca',
        physics: {
            default: 'arcade',
            arcade: { gravity: { y: 1100 }, debug: false }
        },
        scene: { create: create, update: update }
    };

    let bird, pipes, coins;
    let mountains, trees, clouds, stars; 
    let score = 0;
    let gameHasStarted = false;
    let gameOverFlag = false;
    let isNight = false;

    const game = new Phaser.Game(config);

    function create() {
        // GRAFƒ∞KLER (KODLARI SAKLADIM)
        let cloudG = this.make.graphics(); cloudG.fillStyle(0xFFFFFF, 1); cloudG.fillCircle(20, 20, 20); cloudG.fillCircle(45, 20, 25); cloudG.fillCircle(75, 20, 20); cloudG.generateTexture('cloud', 100, 50);
        let starG = this.make.graphics(); starG.fillStyle(0xFFFFFF, 1); starG.fillCircle(4, 4, 4); starG.generateTexture('star', 8, 8);
        let mountG = this.make.graphics(); mountG.fillStyle(0x607D8B, 1); mountG.fillTriangle(0, 100, 100, 0, 200, 100); mountG.generateTexture('mountain', 200, 100);
        let treeG = this.make.graphics(); treeG.fillStyle(0x8D6E63, 1); treeG.fillRect(10, 30, 10, 30); treeG.fillStyle(0x4CAF50, 1); treeG.fillCircle(15, 20, 15); treeG.generateTexture('tree', 30, 60);
        let groundG = this.make.graphics(); groundG.fillStyle(0xDED895, 1); groundG.fillRect(0, 15, 400, 100); groundG.fillStyle(0x73BF2E, 1); groundG.fillRect(0, 0, 400, 15); groundG.lineStyle(3, 0x558C22, 1); groundG.strokeRect(0, 0, 400, 15); groundG.generateTexture('ground', 400, 110);
        let coinG = this.make.graphics(); coinG.fillStyle(0xFFD700, 1); coinG.fillCircle(16, 16, 16); coinG.lineStyle(2, 0xB8860B, 1); coinG.strokeCircle(16, 16, 16); coinG.fillStyle(0xFFFACD, 1); coinG.fillCircle(16, 16, 10); coinG.fillStyle(0xB8860B, 1); coinG.fillRect(14, 9, 4, 14); coinG.generateTexture('coin', 32, 32);
        let pipeG = this.make.graphics(); pipeG.fillStyle(0x73BF2E, 1); pipeG.fillRect(2, 2, 54, 600); pipeG.lineStyle(4, 0x558C22, 1); pipeG.strokeRect(0, 0, 58, 600); pipeG.fillStyle(0x73BF2E, 1); pipeG.fillRect(0, 0, 58, 28); pipeG.strokeRect(0, 0, 58, 28); pipeG.generateTexture('pipe', 60, 600);

        // KU≈ûLAR
        let birdG = this.make.graphics(); birdG.fillStyle(0xFF69B4, 1); birdG.fillTriangle(10,8,14,0,18,8); birdG.fillTriangle(18,8,22,-2,26,8); birdG.fillTriangle(26,8,30,0,34,8); birdG.fillStyle(0xF4CE42, 1); birdG.fillCircle(22, 20, 14); birdG.fillStyle(0xFFFFFF, 1); birdG.fillEllipse(16, 22, 12, 8); birdG.lineStyle(2, 0x000000, 1); birdG.strokeEllipse(16, 22, 12, 8); birdG.fillStyle(0xFFFFFF, 1); birdG.fillCircle(28, 16, 6); birdG.fillStyle(0x000000, 1); birdG.fillCircle(30, 16, 2); birdG.fillStyle(0xF39C12, 1); birdG.fillTriangle(32, 20, 44, 23, 32, 26); birdG.generateTexture('bird_default', 45, 40);
        let redBirdG = this.make.graphics(); redBirdG.fillStyle(0xD72638, 1); redBirdG.fillCircle(25, 22, 17); redBirdG.fillStyle(0x2C3E50, 1); redBirdG.fillRect(6, 17, 20, 6); redBirdG.fillStyle(0x3498DB, 1); redBirdG.fillEllipse(26, 20, 9, 7); redBirdG.lineStyle(2, 0x2C3E50, 1); redBirdG.strokeEllipse(26, 20, 9, 7); redBirdG.fillStyle(0x1a1a1a, 1); redBirdG.beginPath(); redBirdG.moveTo(8, 24); redBirdG.lineTo(32, 24); redBirdG.lineTo(15, 36); redBirdG.closePath(); redBirdG.fill(); redBirdG.fillStyle(0xF1C40F, 1); redBirdG.fillTriangle(36, 18, 50, 22, 36, 26); redBirdG.generateTexture('bird_red', 55, 45); 
        let blueBirdG = this.make.graphics(); blueBirdG.fillStyle(0x3498DB, 1); blueBirdG.fillRect(10, 15, 30, 12); blueBirdG.fillTriangle(40, 15, 55, 21, 40, 27); blueBirdG.fillStyle(0x95a5a6, 1); blueBirdG.fillTriangle(20, 15, 35, 15, 10, 5); blueBirdG.generateTexture('bird_blue', 55, 30);

        // ARKA PLAN
        stars = this.add.tileSprite(config.width/2, config.height/2, config.width, config.height, 'star');
        stars.setAlpha(0);
        mountains = this.add.tileSprite(config.width/2, config.height - 150, config.width, 100, 'mountain');
        mountains.setOrigin(0.5, 1); mountains.setAlpha(0.8);
        clouds = this.add.tileSprite(config.width/2, 100, config.width, 100, 'cloud');
        clouds.setAlpha(0.5);
        trees = this.add.tileSprite(config.width/2, config.height - 110, config.width, 60, 'tree');
        trees.setOrigin(0.5, 1);
        this.ground = this.add.tileSprite(config.width/2, config.height, config.width, 110, 'ground').setOrigin(0.5, 1).setDepth(20);
        this.physics.add.existing(this.ground, true);

        // OYUN NESNELERƒ∞
        pipes = this.physics.add.group();
        coins = this.physics.add.group();

        let textureKey = 'bird_' + currentSkin;
        bird = this.physics.add.sprite(config.width / 4, config.height / 2, textureKey);
        bird.setDepth(10);
        if (currentSkin === 'red') bird.body.setCircle(15, 12, 8);
        else bird.body.setCircle(13, 9, 7);
        
        this.input.on('pointerdown', jump, this);
        this.input.keyboard.on('keydown-SPACE', jump, this);

        this.physics.add.collider(bird, pipes, gameOver, null, this);
        this.physics.add.collider(bird, this.ground, gameOver, null, this);
        this.physics.add.overlap(bird, coins, collectCoin, null, this);

        this.pipeTimer = this.time.addEvent({ delay: 1500, callback: addPipeColumn, callbackScope: this, loop: true, paused: true });
    }

    function update() {
        if (isGamePaused) return;

        if (!gameHasStarted) {
            bird.body.allowGravity = false;
            bird.y = (config.height / 2) + Math.sin(this.time.now / 300) * 8;
            return;
        }
        if (gameOverFlag) return;

        this.ground.tilePositionX += 2.5;
        trees.tilePositionX += 2.5; 
        mountains.tilePositionX += 0.5;
        clouds.tilePositionX += 0.2;

        let cycle = Math.floor(score / 25);
        if (cycle % 2 === 1 && !isNight) {
            isNight = true;
            this.cameras.main.setBackgroundColor('#2c3e50'); 
            stars.setAlpha(1); mountains.setTint(0x555555); trees.setTint(0x555555); this.ground.setTint(0x999999);
        } else if (cycle % 2 === 0 && isNight) {
            isNight = false;
            this.cameras.main.setBackgroundColor('#4ec0ca'); 
            stars.setAlpha(0); mountains.clearTint(); trees.clearTint(); this.ground.clearTint();
        }

        if (bird.angle < 30) bird.angle += 2.5;
        if (bird.y < -50 || bird.y > config.height) gameOver.call(this);
    }

    function jump() {
        if (document.getElementById('market-modal').style.display === 'flex') return;
        if (document.getElementById('leaderboard-modal').style.display === 'flex') return; // Leaderboard a√ßƒ±kken zƒ±plama
        if (document.getElementById('save-modal').style.display === 'flex') return; // Save a√ßƒ±kken zƒ±plama
        
        if (isGamePaused) { togglePause(); return; }
        if (gameOverFlag) { restartGame.call(this); return; }

        if (!gameHasStarted) {
            gameHasStarted = true;
            bird.body.allowGravity = true;
            this.pipeTimer.paused = false;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('bottom-controls').style.display = 'none';
            
            if (audioCtx.state === 'suspended') audioCtx.resume();
        }

        bird.setVelocityY(-350);
        this.tweens.add({ targets: bird, angle: -25, duration: 100 });
        playSynthSound('jump');
    }

    function addPipeColumn() {
        if (gameOverFlag || isGamePaused) return;

        let currentGap = Math.max(85, 140 - (score * 0.5));
        const minPipePiece = 80; 
        const maxAvailableY = config.height - 110 - currentGap - minPipePiece;
        let pipeY;
        let isExtreme = Math.random() < 0.50;

        if (isExtreme) {
            let goTop = Math.random() < 0.5;
            if (goTop) pipeY = minPipePiece; 
            else pipeY = maxAvailableY; 
        } else {
            pipeY = Phaser.Math.Between(minPipePiece, maxAvailableY);
        }

        let topPipe = pipes.create(config.width + 80, pipeY, 'pipe').setOrigin(0.5, 1).setFlipY(true);
        let bottomPipe = pipes.create(config.width + 80, pipeY + currentGap, 'pipe').setOrigin(0.5, 0);

        [topPipe, bottomPipe].forEach(p => {
            p.body.allowGravity = false;
            p.setVelocityX(-200);
        });

        let coinY = pipeY + (currentGap / 2);
        let coin = coins.create(config.width + 80, coinY, 'coin');
        coin.setVelocityX(-200);
        coin.body.allowGravity = false;
        
        this.tweens.add({ targets: coin, scaleX: 0, duration: 600, yoyo: true, repeat: -1 });

        this.time.delayedCall(1500, () => {
             if (!gameOverFlag && gameHasStarted && !isGamePaused) {
                score += 1;
                document.getElementById('current-score').innerText = score;
             }
        });
    }

    function collectCoin(bird, coin) {
        coin.disableBody(true, true);
        totalCoins += 1;
        document.getElementById('total-coins').innerText = totalCoins;
        localStorage.setItem('flappy_coins', totalCoins);
        playSynthSound('coin');
    }

    function gameOver() {
        if (gameOverFlag) return;
        gameOverFlag = true;
        
        this.physics.pause();
        bird.setTint(0xff0000);
        playSynthSound('dead');

        if (score > bestScore) {
            bestScore = score;
            localStorage.setItem('flappy_best', bestScore);
            document.getElementById('best-score').innerText = bestScore;
        }
        localStorage.setItem('flappy_coins', totalCoins);

        document.getElementById('start-msg').innerText = "TEKRAR DENE";
        document.getElementById('start-screen').style.display = 'flex';
        document.getElementById('bottom-controls').style.display = 'flex';
        
        // Eƒüer skor yapƒ±ldƒ±ysa Kaydet butonunu g√∂ster
        if (score > 0) {
            document.getElementById('save-score-btn').style.display = 'inline-block';
        }
    }

    function restartGame() {
        score = 0; isNight = false; isGamePaused = false;
        game.scene.scenes[0].cameras.main.setBackgroundColor('#4ec0ca'); 
        
        gameOverFlag = false;
        gameHasStarted = false;
        document.getElementById('current-score').innerText = "0";
        document.getElementById('start-msg').innerText = "BA≈ûLAMAK ƒ∞√áƒ∞N DOKUN";
        document.getElementById('pause-msg').style.display = 'none';
        
        // Kaydet butonunu gizle
        document.getElementById('save-score-btn').style.display = 'none';
        
        document.getElementById('btn-pause').innerText = '‚è∏Ô∏è';

        this.scene.restart();
    }
    </script>
</body>
</html>
