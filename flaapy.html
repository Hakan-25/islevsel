<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HakanTools | Flappy Hakan</title>
    
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.60.0/dist/phaser-arcade-physics.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');

        /* 1. SAYFA AYARLARI (PC'de Oyunu Ortalar) */
        body { 
            margin: 0; padding: 0; 
            background-color: #2c3e50; /* PC Arka Planƒ± */
            overflow: hidden; 
            font-family: 'Inter', sans-serif; 
            touch-action: none; 
            height: 100vh; width: 100vw;
            display: flex; justify-content: center; align-items: center; 
            -webkit-user-select: none; user-select: none;
        }

        /* Oyunun Kendisi (Canvas) */
        canvas {
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            border-radius: 15px;
        }

        /* 2. ARAY√úZ (UI) - Sadece Canvas √úzerinde Dursun */
        #game-container {
            position: relative;
            width: 100%; height: 100%;
            max-width: 450px; /* PC'de Mobil Boyutu */
            max-height: 800px;
            overflow: hidden;
        }

        /* √úst Bar */
        #top-ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100;
        }

        .home-btn {
            position: absolute; top: 20px; left: 20px; pointer-events: auto;
            text-decoration: none; background: white; width: 45px; height: 45px;
            border-radius: 12px; display: flex; justify-content: center; align-items: center;
            font-size: 24px; box-shadow: 0 4px 0 #2c7a81; border: 2px solid #fff;
        }
        .home-btn:active { transform: translateY(3px); box-shadow: none; }

        .stats-wrapper {
            position: absolute; top: 20px; right: 20px;
            display: flex; flex-direction: column; align-items: flex-end; gap: 8px; pointer-events: auto;
        }

        .stat-pill {
            background: rgba(0, 0, 0, 0.6); color: white; padding: 6px 12px;
            border-radius: 20px; font-size: 13px; font-weight: 700;
            display: flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.4);
        }

        .icon-btn {
            background: #FFD700; width: 45px; height: 45px; border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            font-size: 20px; cursor: pointer; border: 2px solid #fff;
            box-shadow: 0 4px 0 #B8860B; margin-top: 5px;
        }
        .icon-btn:active { transform: translateY(3px); box-shadow: none; }
        .shop-btn { background: #9b59b6; box-shadow: 0 4px 0 #8e44ad; color: white; }

        /* Skor ve Mesajlar */
        #current-score {
            position: absolute; top: 15%; left: 50%; transform: translateX(-50%);
            font-size: 80px; font-weight: 900; color: white;
            text-shadow: 4px 4px 0 rgba(0,0,0,0.2); pointer-events: none; z-index: 10;
        }

        #start-msg {
            position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%);
            font-size: 22px; color: white; font-weight: 800; text-shadow: 2px 2px 0 rgba(0,0,0,0.3);
            animation: pulse 1s infinite; pointer-events: none; z-index: 50; width: 100%; text-align: center;
        }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }

        /* MODALLAR */
        .modal-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200;
            display: flex; justify-content: center; align-items: center;
        }
        .hidden { display: none !important; }

        .modal-content {
            background: linear-gradient(135deg, #4ec0ca, #3da0a9);
            padding: 25px; border-radius: 20px; text-align: center;
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); border: 4px solid white;
            width: 85%; max-width: 320px; position: relative;
        }

        /* Market Tasarƒ±mƒ± */
        #shop-list {
            display: flex; overflow-x: auto; gap: 15px; padding: 10px 0;
            scroll-behavior: smooth;
        }
        .shop-item {
            background: rgba(0,0,0,0.2); border-radius: 15px; padding: 15px;
            min-width: 140px; display: flex; flex-direction: column; align-items: center; gap: 10px;
            border: 2px solid transparent; transition: 0.2s;
        }
        .shop-item.selected { border-color: #FFD700; background: rgba(255, 215, 0, 0.2); }
        .bird-preview { width: 60px; height: 50px; background-size: contain; background-repeat: no-repeat; background-position: center; }
        
        .buy-btn {
            background: #27ae60; color: white; border: none; padding: 8px 15px;
            border-radius: 20px; font-weight: bold; cursor: pointer; font-size: 14px;
        }
        .buy-btn:disabled { background: #7f8c8d; cursor: not-allowed; }
        .use-btn { background: #2980b9; }

        /* Ortak Butonlar */
        .modal-input { width: 85%; padding: 12px; border-radius: 10px; border: none; margin-bottom: 15px; text-align: center; font-weight: bold; }
        .modal-btn { background: #fff; color: #4ec0ca; padding: 12px 30px; border-radius: 50px; font-weight: 900; border:none; cursor: pointer; box-shadow: 0 4px 0 #2c7a81; }
        .modal-btn:active { transform: translateY(3px); box-shadow: none; }
        .close-btn { position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; width: 30px; height: 30px; border-radius: 50%; border: none; font-weight: bold; cursor: pointer; }

    </style>
</head>
<body>

<div id="game-container">
    <div id="top-ui">
        <a href="index.html" class="home-btn">üè†</a>
        <div class="stats-wrapper">
            <div class="stat-pill">üèÜ <span id="best-score">0</span></div>
            <div class="stat-pill">üí∞ <span id="total-coins">0</span></div>
            <button class="icon-btn" onclick="openLeaderboard()">ü•á</button>
            <button class="icon-btn shop-btn" onclick="openShop()">üõí</button>
        </div>
        <div id="current-score">0</div>
        <div id="start-msg">BA≈ûLAMAK ƒ∞√áƒ∞N DOKUN</div>
    </div>

    <div id="login-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="color:white; margin:0 0 15px 0;">HO≈û GELDƒ∞N Pƒ∞LOT!</h2>
            <input type="text" id="nickname-input" class="modal-input" placeholder="ƒ∞smin (Max 10)" maxlength="10">
            <button class="modal-btn" onclick="kullaniciKaydet()">BA≈ûLA</button>
        </div>
    </div>

    <div id="shop-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px;">
            <button class="close-btn" onclick="closeShop()">X</button>
            <h2 style="color:white; margin:0 0 10px 0;">KU≈û MARKETƒ∞</h2>
            <div style="color:white; font-size:14px; margin-bottom:15px;">Paran: <span id="shop-coins" style="color:#FFD700; font-weight:bold;">0</span></div>
            <div id="shop-list">
                </div>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <button class="close-btn" onclick="closeLeaderboard()">X</button>
            <h2 style="color:white; margin:0 0 10px 0;">EN ƒ∞Yƒ∞LER</h2>
            <div id="loading-text" style="color:white;">Y√ºkleniyor...</div>
            <ul id="leaderboard-list" style="list-style:none; padding:0; text-align:left; color:white; max-height:200px; overflow-y:auto;"></ul>
        </div>
    </div>
</div>

<script>
// --- FIREBASE ---
const firebaseConfig = {
    apiKey: "AIzaSyBW8xNsDjp3duXyuPukuBKNlOYw-uv6W1c",
    authDomain: "hakantools-a44c0.firebaseapp.com",
    projectId: "hakantools-a44c0",
    storageBucket: "hakantools-a44c0.firebasestorage.app",
    messagingSenderId: "216753237718",
    appId: "1:216753237718:web:ea012c7dc4fdb7e7d72377",
    measurementId: "G-4GWK9BS40T"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// --- DEƒûƒ∞≈ûKENLER ---
let bird, pipes, coins, score=0, gameHasStarted=false, gameOverFlag=false;
let bestScore = parseInt(localStorage.getItem('flappy_best')) || 0;
let totalCoins = parseInt(localStorage.getItem('flappy_coins')) || 0;
let currentBird = localStorage.getItem('flappy_skin') || 'bird_default';
let ownedBirds = JSON.parse(localStorage.getItem('flappy_owned')) || ['bird_default'];

// --- KARAKTER VERƒ∞LERƒ∞ ---
const SKINS = [
    { id: 'bird_default', name: 'Normal Ku≈ü', price: 0, color: 0xFF69B4 },
    { id: 'bird_elyo', name: 'Elyo (G√∂zl√ºkl√º)', price: 350, color: 0x3498db },
    { id: 'bird_hakan', name: 'Derbeder Hakan', price: 350, color: 0xe74c3c },
    { id: 'bird_goth', name: '...', price: 350, color: 0x2c3e50 }
];

// --- UI G√úNCELLEME ---
function updateUI() {
    if(document.getElementById('best-score')) document.getElementById('best-score').innerText = bestScore;
    if(document.getElementById('total-coins')) document.getElementById('total-coins').innerText = totalCoins;
    if(document.getElementById('shop-coins')) document.getElementById('shop-coins').innerText = totalCoins;
}
updateUI();

// --- MARKET Sƒ∞STEMƒ∞ ---
function openShop() {
    document.getElementById('shop-modal').classList.remove('hidden');
    renderShop();
}
function closeShop() { document.getElementById('shop-modal').classList.add('hidden'); }

function renderShop() {
    const list = document.getElementById('shop-list');
    list.innerHTML = "";
    SKINS.forEach(skin => {
        const isOwned = ownedBirds.includes(skin.id);
        const isSelected = currentBird === skin.id;
        
        let btnHTML = "";
        if (isSelected) btnHTML = `<button class="buy-btn" disabled>SE√áƒ∞Lƒ∞</button>`;
        else if (isOwned) btnHTML = `<button class="buy-btn use-btn" onclick="selectSkin('${skin.id}')">SE√á</button>`;
        else btnHTML = `<button class="buy-btn" onclick="buySkin('${skin.id}', ${skin.price})">${skin.price} üí∞</button>`;

        const item = document.createElement('div');
        item.className = `shop-item ${isSelected ? 'selected' : ''}`;
        item.innerHTML = `
            <div style="font-weight:bold; color:white; font-size:14px;">${skin.name}</div>
            <div id="preview-${skin.id}" class="bird-preview"></div>
            ${btnHTML}
        `;
        list.appendChild(item);
        
        // √ñnizleme √áizimi (Canvas i√ßinde k√º√ß√ºk bir ku≈ü √ßiz)
        setTimeout(() => drawPreview(skin.id, skin.color), 50);
    });
}

function buySkin(id, price) {
    if (totalCoins >= price) {
        totalCoins -= price;
        ownedBirds.push(id);
        localStorage.setItem('flappy_coins', totalCoins);
        localStorage.setItem('flappy_owned', JSON.stringify(ownedBirds));
        selectSkin(id); // Satƒ±n alƒ±nca otomatik se√ß
        updateUI();
        renderShop();
    } else {
        alert("Yetersiz Bakiye!");
    }
}

function selectSkin(id) {
    currentBird = id;
    localStorage.setItem('flappy_skin', currentBird);
    renderShop();
    // Oyundaki ku≈üu g√ºncelle (eƒüer oyun ba≈ülamadƒ±ysa)
    if (!gameHasStarted && !gameOverFlag) {
        game.scene.scenes[0].scene.restart();
    }
}

// --- KULLANICI & Lƒ∞DERLƒ∞K ---
window.addEventListener('load', () => {
    const uid = localStorage.getItem('hakan_flappy_uid');
    if (uid) {
        document.getElementById('login-modal').classList.add('hidden');
        verileriGuncelle(uid);
    }
});

function kullaniciKaydet() {
    const isim = document.getElementById('nickname-input').value.trim();
    if (!isim) { alert("ƒ∞sim yaz!"); return; }
    db.collection("leaderboard").add({ name: isim, score: bestScore, coins: totalCoins }).then(doc => {
        localStorage.setItem('hakan_flappy_uid', doc.id);
        document.getElementById('login-modal').classList.add('hidden');
    });
}

function verileriGuncelle(uid) {
    db.collection("leaderboard").doc(uid).onSnapshot(doc => {
        if (doc.exists) {
            const d = doc.data();
            localStorage.setItem('flappy_best', d.score);
            localStorage.setItem('flappy_coins', d.coins || 0);
            bestScore = d.score; totalCoins = d.coins || 0;
            updateUI();
        }
    });
}

function saveToDB() {
    const uid = localStorage.getItem('hakan_flappy_uid');
    if (!uid) return;
    const ref = db.collection("leaderboard").doc(uid);
    db.runTransaction(t => t.get(ref).then(doc => {
        const old = doc.data().score || 0;
        t.update(ref, { score: Math.max(score, old), coins: totalCoins });
    }));
}

function openLeaderboard() {
    document.getElementById('leaderboard-modal').classList.remove('hidden');
    const list = document.getElementById('leaderboard-list');
    list.innerHTML = "";
    db.collection("leaderboard").orderBy("score", "desc").limit(10).get().then(snap => {
        document.getElementById('loading-text').style.display="none";
        snap.forEach((doc, i) => {
            const d = doc.data();
            list.innerHTML += `<li style="padding:8px; border-bottom:1px solid rgba(255,255,255,0.2)">${i+1}. ${d.name} - <b>${d.score}</b></li>`;
        });
    });
}
function closeLeaderboard() { document.getElementById('leaderboard-modal').classList.add('hidden'); }

// --- PHASER OYUN ---
const config = {
    type: Phaser.AUTO,
    parent: 'game-container', // Oyunu bu div'in i√ßine g√∂m
    scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH, width: 450, height: 800 },
    transparent: true,
    physics: { default: 'arcade', arcade: { gravity: { y: 1200 }, debug: false } },
    scene: { create: create, update: update }
};

const game = new Phaser.Game(config);
let lastPipeY = 400; // Akƒ±llƒ± boru algoritmasƒ± i√ßin

function create() {
    drawAssets(this); // Grafikleri √ßiz

    pipes = this.physics.add.group(); coins = this.physics.add.group();
    
    // Se√ßili Karakteri Yarat
    bird = this.physics.add.sprite(100, 400, currentBird); 
    bird.setDepth(10); bird.body.setCircle(13,9,7);

    let ground = this.add.tileSprite(225, 800, 450, 110, 'ground').setOrigin(0.5, 1).setDepth(20);
    this.physics.add.existing(ground, true);
    this.ground = ground;

    this.input.on('pointerdown', jump, this); 
    this.input.keyboard.on('keydown-SPACE', jump, this);
    
    this.physics.add.collider(bird, pipes, gameOver, null, this);
    this.physics.add.collider(bird, ground, gameOver, null, this);
    this.physics.add.overlap(bird, coins, collectCoin, null, this);

    this.time.addEvent({ delay: 1500, callback: addPipe, callbackScope: this, loop: true });
}

function update(time, delta) {
    if(!gameHasStarted) { bird.body.allowGravity=false; bird.y = 400 + Math.sin(time/300)*10; return; }
    if(gameOverFlag) return;
    
    this.ground.tilePositionX += 2.5 * (delta/16);
    if(bird.angle < 30) bird.angle += 2.5;
    if(bird.y < -50 || bird.y > 800) gameOver();

    // Temizlik
    pipes.children.iterate(p => { if(p && p.x < -60) p.destroy(); });
    coins.children.iterate(c => { if(c && c.x < -60) c.destroy(); });
}

function jump() {
    if(!document.getElementById('shop-modal').classList.contains('hidden')) return; // Market a√ßƒ±kken zƒ±plama
    if(!document.getElementById('leaderboard-modal').classList.contains('hidden')) return;
    
    if(gameOverFlag) { restartGame.call(this.scene); return; }
    if(!gameHasStarted) { 
        gameHasStarted=true; bird.body.allowGravity=true; 
        document.getElementById('start-msg').style.display='none'; 
    }
    bird.setVelocityY(-400); 
    this.tweens.add({ targets: bird, angle: -25, duration: 100 });
}

function addPipe() {
    if(!gameHasStarted || gameOverFlag) return;

    // --- AKILLI BORU ALGORƒ∞TMASI ---
    // Bir √∂nceki borudan en fazla 150 piksel yukarƒ± veya a≈üaƒüƒ± gidebilir
    let minY = Math.max(200, lastPipeY - 150);
    let maxY = Math.min(600, lastPipeY + 150);
    let y = Phaser.Math.Between(minY, maxY);
    lastPipeY = y; // Kaydet
    
    let gap = Math.max(95, 140 - (score*0.2)); // Zorluk yava≈ü√ßa artar

    let top = pipes.create(500, y - gap/2, 'pipe').setOrigin(0.5, 1).setFlipY(true);
    let bot = pipes.create(500, y + gap/2, 'pipe').setOrigin(0.5, 0);
    
    [top, bot].forEach(p => { p.body.allowGravity=false; p.setVelocityX(-200); });

    if(Math.random() > 0.6) {
        let c = coins.create(500, y, 'coin');
        c.setVelocityX(-200); c.body.allowGravity=false;
        this.tweens.add({ targets: c, scaleX: 0, duration: 500, yoyo: true, repeat: -1 });
    }

    // Puan
    setTimeout(() => { if(!gameOverFlag) { score++; document.getElementById('current-score').innerText=score; } }, 1500);
}

function collectCoin(b, c) {
    c.destroy();
    totalCoins++; updateUI();
}

function gameOver() {
    if(gameOverFlag) return; gameOverFlag=true;
    this.physics.pause(); bird.setTint(0xff0000);
    
    if(score > bestScore) { bestScore=score; localStorage.setItem('flappy_best', bestScore); }
    localStorage.setItem('flappy_coins', totalCoins);
    saveToDB();

    document.getElementById('start-msg').innerText = "TEKRAR DENE";
    document.getElementById('start-msg').style.display = 'block';
    
    // √ñl√ºnce market butonunu g√∂ster (Eƒüer oyun i√ßinde gizlediysek)
}

function restartGame() {
    gameOverFlag=false; gameHasStarted=false; score=0;
    document.getElementById('current-score').innerText="0";
    game.scene.scenes[0].scene.restart();
}

// --- GRAFƒ∞K √áƒ∞Zƒ∞MLERƒ∞ (ASSETS) ---
function drawAssets(scene) {
    // Boru
    let pipeG = scene.make.graphics();
    pipeG.fillStyle(0x73BF2E); pipeG.fillRect(2,0,56,800);
    pipeG.lineStyle(4, 0x558C22); pipeG.strokeRect(0,0,60,800);
    pipeG.fillStyle(0x73BF2E); pipeG.fillRect(0,0,60,30);
    pipeG.strokeRect(0,0,60,30);
    pipeG.generateTexture('pipe', 60, 800);

    // Zemin
    let groundG = scene.make.graphics();
    groundG.fillStyle(0xDED895); groundG.fillRect(0,10,450,100);
    groundG.fillStyle(0x73BF2E); groundG.fillRect(0,0,450,10);
    groundG.generateTexture('ground', 450, 110);

    // Altƒ±n
    let coinG = scene.make.graphics();
    coinG.fillStyle(0xFFD700); coinG.fillCircle(15,15,15);
    coinG.fillStyle(0xF1C40F); coinG.fillCircle(15,15,10);
    coinG.generateTexture('coin', 30, 30);

    // 1. NORMAL KU≈û (Pembe)
    drawBird(scene, 'bird_default', 0xFF69B4);

    // 2. ELYO (Mavi, G√∂zl√ºkl√º)
    drawBird(scene, 'bird_elyo', 0x3498db, true);

    // 3. DERBEDER HAKAN (Kƒ±rmƒ±zƒ±, Sigaralƒ±)
    drawBird(scene, 'bird_hakan', 0xe74c3c, false, true);

    // 4. GOTƒ∞K ... (Siyah)
    drawBird(scene, 'bird_goth', 0x2c3e50);
}

function drawBird(scene, key, color, glasses=false, cig=false) {
    let g = scene.make.graphics();
    g.fillStyle(color); g.fillCircle(22,20,18); // V√ºcut
    g.fillStyle(0xFFFFFF); g.fillCircle(28,16,6); // G√∂z Beyazƒ±
    g.fillStyle(0x000000); g.fillCircle(30,16,2); // G√∂z Bebeƒüi
    g.fillStyle(0xF39C12); g.fillTriangle(32,20, 48,23, 32,26); // Gaga
    g.fillStyle(0xFFFFFF); g.fillCircle(12,20,5); // Kanat

    if(glasses) { // G√∂zl√ºk
        g.lineStyle(2, 0x000000); g.strokeRect(22, 12, 14, 8); g.lineStyle(1, 0x000000); g.beginPath(); g.moveTo(22,16); g.lineTo(10,18); g.strokePath();
    }
    if(cig) { // Sigara
        g.fillStyle(0xFFFFFF); g.fillRect(35, 24, 12, 3);
        g.fillStyle(0xE74C3C); g.fillCircle(47, 25.5, 1.5); // Ate≈ü
        // Duman
        g.fillStyle(0xBDC3C7); g.fillCircle(50, 22, 2); g.fillCircle(53, 19, 3);
    }

    g.generateTexture(key, 50, 40);
}

// Market √ñnizlemesi ƒ∞√ßin (DOM Canvas)
function drawPreview(id, color) {
    // Bu kƒ±sƒ±m sadece markette ikon olarak g√∂stermek i√ßin basit CSS background veya k√º√ß√ºk canvas kullanƒ±r
    // Basitlik i√ßin sadece renkli kutu yapƒ±yoruz, Phaser texture'ƒ±nƒ± DOM'a aktarmak karma≈üƒ±ktƒ±r.
    const el = document.getElementById(`preview-${id}`);
    if(el) {
        el.style.backgroundColor = '#' + color.toString(16);
        el.style.borderRadius = "50%";
        el.style.border = "3px solid white";
        el.style.boxShadow = "0 4px 0 rgba(0,0,0,0.2)";
    }
}
</script>
</body>
</html>
